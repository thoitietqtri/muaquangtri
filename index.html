<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LƯỢNG MƯA CÁC TRẠM TỰ ĐỘNG - Tổng 6h</title>

  <style>
    :root{
      --bg:#f6f8ff; --card:#fff; --txt:#0f172a; --muted:#64748b; --pri:#1d4ed8;
      --grid:#e2e8f0; --grid-strong:#94a3b8; --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:var(--txt);}

    header{
      position:sticky; top:0; z-index:30;
      background:#fff; border-bottom:1px solid var(--grid); padding:14px 18px;
    }
    .title{margin:0; text-align:center; color:var(--pri); font-weight:800}
    .l1{font-size:18px; text-transform:uppercase}
    .l2{font-size:12px; color:#334155; margin-top:6px}

    .shell{max-width:1400px; margin:18px auto; padding:0 12px; display:grid; grid-template-columns: 380px 1fr; gap:14px;}

    .card{background:var(--card); border:1px solid var(--grid); border-radius:var(--radius); padding:12px; box-shadow:0 8px 20px rgba(2,6,23,0.04)}

    /* left sidebar */
    aside .section-title{font-weight:800; margin-bottom:8px}

    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input,select,button{padding:8px 10px; border:1px solid #e6eef8; border-radius:10px; font-size:14px}
    .row{display:flex; gap:8px}
    .btn{background:var(--pri); color:#fff; border:none; cursor:pointer; font-weight:700; padding:8px 12px; border-radius:10px}
    .btn.ghost{background:#eef2ff; color:#1e40af}
    .btn.secondary{background:#64748b}

    /* results area */
    .results{display:flex; flex-direction:column; gap:12px}
    .actions-row{display:flex; align-items:center; gap:12px; margin-bottom:6px}
    /* IMPORTANT: actions-row is OUTSIDE any overflow container so it's static and won't scroll inside table */
    .actions-row .btn{padding:12px 20px; font-size:16px; border-radius:14px}

    /* 6h matrix */
    .matrix-wrap{overflow:auto; border:1px solid #eef2f6; border-radius:8px; background:#fff; padding:8px}
    .matrix-table{border-collapse:collapse; width:100%;}
    .matrix-table th, .matrix-table td{border:1px solid #eef2f6; padding:6px 8px; text-align:center; white-space:nowrap; font-size:13px}
    .matrix-table thead th{background:#fbfbff; font-weight:800; position:sticky; top:0; z-index:5}
    .station-col{position:sticky; left:0; background:#fff; text-align:left; font-weight:700; z-index:6}

    /* main data table */
    .table-scroll{overflow:auto; border-radius:8px; background:#fff; border:1px solid #eef2f6}
    .rain-table{border-collapse:separate; border-spacing:0; width:100%; min-width:720px}
    .rain-table th, .rain-table td{border-bottom:1px solid #eef2f6; padding:8px; text-align:center; white-space:nowrap}
    .rain-table thead th{position:sticky; top:0; background:#f8fafc; z-index:3; font-weight:800}
    .rain-table td.time{position:sticky; left:0; background:#fff; text-align:left; font-weight:700; z-index:4}

    @media (max-width:1000px){
      .shell{grid-template-columns:1fr}
    }
  </style>
  <!-- xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <div class="title">
    <div class="l1">LƯỢNG MƯA CÁC TRẠM TỰ ĐỘNG</div>
    <div class="l2">Hiển thị tổng 6 giờ — Quảng Trị</div>
  </div>
</header>

<div class="shell">
  <!-- SIDEBAR -->
  <aside class="card">
    <div class="section">
      <div class="section-title">Nguồn dữ liệu</div>
      <div class="row">
        <button id="btnAutoXlsx" class="btn">Tải tự động</button>
        <input id="fileXlsx" type="file" accept=".xlsx" />
      </div>
      <div id="xlsxStatus" style="margin-top:8px;color:#64748b;font-size:13px">Chưa tải file Excel.</div>
      <label style="margin-top:10px">Passcode (nếu API yêu cầu)</label>
      <input id="passcode" type="text" placeholder="để trống nếu không cần">
    </div>

    <hr style="margin:10px 0;border:none;border-top:1px solid #eef2f6">

    <div class="section">
      <div class="section-title">Chọn trạm & thời gian</div>
      <label>Chọn các trạm</label>
      <select id="multiSelect" multiple size="10" style="width:100%;height:240px"></select>

      <label style="margin-top:8px">Bắt đầu</label>
      <input id="startDt" type="datetime-local" />
      <label style="margin-top:8px">Kết thúc</label>
      <input id="endDt" type="datetime-local" />

      <div style="margin-top:8px">
        <label>Chu kỳ (sophut)</label>
        <input id="sophut" type="number" value="60" min="1" />
      </div>

      <div style="margin-top:8px">
        <label><input id="tinhtong" type="checkbox" checked /> Tính tổng theo ngày (tinhtong=1)</label>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px">
        <button id="btnFetch" class="btn">Lấy dữ liệu</button>
        <button id="btnClear" class="btn secondary">Xoá</button>
      </div>
    </div>

    <hr style="margin:10px 0;border:none;border-top:1px solid #eef2f6">

    <div class="section">
      <div class="section-title">Tổng hợp</div>
      <label><input id="showAggregates" type="checkbox" checked /> Hiển thị bảng tổng hợp (1h/3h/6h + 6h-blocks)</label>
      <div style="margin-top:8px; display:flex; gap:8px">
        <button id="btnExportAgg" class="btn ghost" disabled>Tải CSV tổng hợp</button>
        <button id="btnExport6hBlocks" class="btn ghost" disabled>Tải CSV 6h-blocks</button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <div class="card results">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div id="summary" style="color:#334155">Chưa có dữ liệu.</div>
        <div style="display:flex; gap:8px">
          <button id="btnExport" class="btn ghost" disabled>Tải CSV</button>
          <button id="btnExportXlsx" class="btn ghost" disabled>Tải Excel (.xlsx)</button>
        </div>
      </div>

      <!-- ACTIONS ROW (STATIC, nằm ngoài vùng cuộn) -->
      <div class="actions-row">
        <div id="staticActions">
          <button id="btnExportFloating" class="btn ghost" disabled>Tải CSV</button>
          <button id="btnExportXlsxFloating" class="btn ghost" disabled>Tải Excel (.xlsx)</button>
        </div>
        <div style="flex:1"></div>
        <div style="font-size:13px;color:#64748b">Bảng 6h: non-overlapping windows bắt đầu từ startDt</div>
      </div>

      <!-- MATRIX 6H (sẽ hiển thị sau khi fetch) -->
      <div id="matrixArea" class="card matrix-wrap" style="display:none">
        <div style="margin-bottom:8px; display:flex; justify-content:space-between; align-items:center">
          <div style="font-weight:800">Bảng tổng 6 giờ (mỗi ô = SUM trong khung 6h)</div>
          <div style="font-size:13px;color:#64748b">Cột: khung 6h bắt đầu từ Start</div>
        </div>
        <div id="matrixHolder" style="overflow:auto"></div>
      </div>

      <!-- DATA TABLE -->
      <div class="table-scroll" style="margin-top:8px">
        <table id="dataTable" class="rain-table">
          <thead><tr id="thead"></tr></thead>
          <tbody id="tbody"></tbody>
          <tfoot id="tfoot"></tfoot>
        </table>
      </div>
    </div>
  </main>
</div>

<script>
/* CONFIG */
const API_PROXY = "/.netlify/functions/proxy";
const DEFAULT_XLSX_PATH = "/thamso_khaithac.xlsx";
const EXCEL_SHEET = "KhaibaoQuangtri";

/* UTILS */
const $ = s => document.querySelector(s);
const pad = n => String(n).padStart(2,'0');
function toLocalDT(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function quote(s){ return `'${s}'`; }
function buildProxyUrl(p){ return `${API_PROXY}?` + new URLSearchParams(p).toString(); }
function safeNum(v){ const n=Number(String(v??'').replace(',','.')); return isFinite(n)?n:NaN; }

/* XLSX helper */
function normalizeRow(r){
  const pick=(a,b)=> (a!==undefined && a!=='')?a:b;
  return {
    matram:String(pick(r.matram,r.MATRAM)||'').trim(),
    tentram:String(pick(r.tentram,r.TENTRAM)||'').trim(),
    Tab:String(pick(r.Tab,r.tab)||'').trim(),
    sophut:Number(pick(r.sophut,r.SOPHUT)||60)||60,
    tinhtong:Number(pick(r.tinhtong,r.TINHTONG)||0)||0
  };
}

/* FILE / STATIONS */
let stations = [];
function loadFromWorkbook(wb){
  const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(ws,{defval:''});
  stations = arr.map(normalizeRow).filter(r=>r.matram);
  if(!stations.length) throw new Error('Không đọc được danh sách trạm từ Excel.');
  $('#xlsxStatus').textContent = `Đã nạp ${stations.length} trạm.`;
  fillStationSelects();
}
async function tryAutoLoadExcel(){
  $('#xlsxStatus').textContent = 'Đang tải thamso_khaithac.xlsx...';
  const res = await fetch(DEFAULT_XLSX_PATH);
  if(!res.ok) throw new Error('Không thấy /thamso_khaithac.xlsx');
  const ab = await res.arrayBuffer();
  const wb = XLSX.read(ab,{type:'array'});
  loadFromWorkbook(wb);
}

function fillStationSelects(){
  const sel = $('#multiSelect'); sel.innerHTML = '';
  stations.forEach((r,i)=> {
    const o = document.createElement('option'); o.value=i; o.textContent = r.tentram || r.matram;
    sel.appendChild(o);
  });
  for(let i=0;i<Math.min(6,stations.length);i++) sel.options[i].selected = true;
}

/* FETCH JSON with fallback */
async function fetchJSON(url){
  async function doFetch(u){
    const res = await fetch(u, { credentials:'include' });
    const txt = await res.text();
    if(!res.ok) throw new Error(txt||`HTTP ${res.status}`);
    try { return JSON.parse(txt); } catch(e){ throw new Error(txt.slice(0,180)); }
  }
  try{ return await doFetch(url); }
  catch(e){ const proxy='https://api.allorigins.win/raw?url='+encodeURIComponent(url); return await doFetch(proxy); }
}

/* PIVOT KEYS */
const TIME_KEYS=['thoigian','Thoigian','thoigian_SL','Thoigian_SL','ThoiGian','ThoiGian_SL','time','datetime','date','Ngay','NgayGio','ngaygio'];
const VALUE_KEYS=['solieu','SoLieu','Solieu','GiaTri','giatri','mucnuoc','MucNuoc','value','LuongMua','luongmua','Mua'];
function pickField(row, keys){ for(const k of keys){ if(row[k]!==undefined && row[k]!==null && row[k]!=='' ) return row[k]; } }
const normTime = t => t==null ? '' : String(t).trim().replace('T',' ');

/* PARSE TIME */
function parseTimeString(t){
  if(!t && t!==0) return null;
  if(t instanceof Date) return t;
  let s = String(t).trim();
  if(!s) return null;
  try{
    s = s.replace('T',' ').replace(/\.\d+$/,'');
    if(s.includes('/') && /^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){
      const parts = s.split(/[\/\s:]+/);
      const d=parts[0], m=parts[1], y=parts[2];
      const rest = parts.slice(3);
      const tp = rest.length? (' '+rest.slice(0,3).map(x=>x.padStart(2,'0')).join(':')) : '';
      s = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}${tp}`;
    }
    const dtParts = s.split(' ');
    if(dtParts.length===2 && dtParts[1].split(':').length===2) s += ':00';
    const dobj = new Date(s);
    if(!isNaN(dobj.getTime())) return dobj;
  }catch(e){}
  const d2 = new Date(Date.parse(s));
  return isNaN(d2.getTime())? null : d2;
}

/* CSV export */
function toCSV(rows){
  if(!rows?.length) return '';
  const cols = Object.keys(rows[0]);
  const esc = v=> `"${String(v??'').replace(/"/g,'""')}"`;
  const head = cols.map(esc).join(',');
  const body = rows.map(r => cols.map(c => esc(r[c])).join(',')).join('\n');
  return head + '\n' + body;
}
function downloadCSV(rows, filename='data.csv'){
  const csv = toCSV(rows); if(!csv) return;
  const bom = '\uFEFF';
  const blob = new Blob([bom, csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function downloadXLSX(rows){
  if(!rows?.length) return;
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'DuLieu');
  XLSX.writeFile(wb, 'rain_ketqua.xlsx');
}

/* RENDER MAIN TABLE */
function mmClass(v){ if(!isFinite(v)) return ''; if(v<10) return ''; if(v<=25) return ''; if(v<=50) return ''; return ''; }
function renderTable(rows){
  const thead = $('#thead'), tbody = $('#tbody'), tfoot = $('#tfoot');
  thead.innerHTML=''; tbody.innerHTML=''; tfoot.innerHTML='';
  if(!rows?.length){ thead.innerHTML='<th>(trống)</th>'; $('#summary').textContent='Không có dữ liệu.'; $('#btnExport').disabled=true; $('#btnExportXlsx').disabled=true; $('#btnExportFloating').disabled=true; $('#btnExportXlsxFloating').disabled=true; return; }

  const cols = Object.keys(rows[0]);
  const timeCol = cols.find(c=>c.toLowerCase().includes('thoi') && c.toLowerCase().includes('gian')) || cols.find(c=>/time|date|ngay/i.test(c)) || cols[0];
  const stationCols = cols.filter(c=>c!==timeCol);

  // header
  thead.innerHTML = `<tr>${[timeCol, ...stationCols].map(c=>`<th>${c}</th>`).join('')}</tr>`;

  const totals = Object.fromEntries(stationCols.map(c=>[c,0]));
  const frag = document.createDocumentFragment();
  for(const r of rows){
    const tr = document.createElement('tr');
    const tdTime = document.createElement('td'); tdTime.className='time'; tdTime.textContent = r[timeCol]||''; tr.appendChild(tdTime);
    for(const c of stationCols){
      const raw = r[c]; const num = Number(String(raw??'').replace(',','.'));
      if(isFinite(num)) totals[c] += num;
      const td = document.createElement('td'); td.textContent = isFinite(num)? num.toFixed(1) : (raw==null?'':raw);
      td.className = mmClass(num); tr.appendChild(td);
    }
    frag.appendChild(tr);
  }
  tbody.appendChild(frag);

  // footer totals
  const trf = document.createElement('tr'); trf.innerHTML = `<td class="time"><b>Tổng (mm)</b></td>` + stationCols.map(c=>`<td style="font-weight:900;color:#c1121f">${(totals[c]||0).toFixed(1)}</td>`).join('');
  tfoot.appendChild(trf);

  $('#summary').textContent = `Hiển thị ${rows.length} mốc thời gian — ${stationCols.length} trạm.`;
  $('#btnExport').disabled=false; $('#btnExportXlsx').disabled=false; $('#btnExportFloating').disabled=false; $('#btnExportXlsxFloating').disabled=false;
  window.__lastRows = rows;
}

/* BUILD PER-STATION SERIES */
function buildSeriesFromRows(rows){
  if(!rows?.length) return {};
  const cols = Object.keys(rows[0]);
  const timeCol = cols.find(c=>c.toLowerCase().includes('thoi') && c.toLowerCase().includes('gian')) || cols.find(c=>/time|date|ngay/i.test(c)) || cols[0];
  const stationCols = cols.filter(c=>c!==timeCol);
  const series = {};
  for(const s of stationCols) series[s]=[];
  for(const r of rows){
    const tRaw = r[timeCol]; const t = parseTimeString(tRaw);
    if(!t) continue;
    for(const s of stationCols){
      const v = safeNum(r[s]);
      if(!isFinite(v)) continue;
      series[s].push({t, v});
    }
  }
  for(const k of Object.keys(series)) series[k].sort((a,b)=>a.t-b.t);
  return series;
}

/* SLIDING window sums (for max 1h/3h/6h) - two pointers */
function slidingWindowSums(series, windowMinutes){
  const n = series.length; if(n===0) return [];
  const res = new Array(n).fill(0);
  const winMs = windowMinutes*60*1000;
  let left=0, cur=0;
  for(let right=0; right<n; right++){
    cur += series[right].v;
    while(left<=right && (series[right].t - series[left].t) >= winMs){
      cur -= series[left].v; left++;
    }
    res[right]=cur;
  }
  return res;
}
function latestWindowSum(series, endTime, windowMinutes){
  if(!series || !series.length) return 0;
  const winMs = windowMinutes*60*1000;
  const startMs = endTime.getTime() - winMs;
  let sum=0;
  for(let i=series.length-1;i>=0;i--){
    const tt = series[i].t.getTime();
    if(tt> endTime.getTime()) continue;
    if(tt <= startMs) break;
    sum += series[i].v;
  }
  return Number(sum.toFixed(1));
}

/* FIXED non-overlapping windows sums (e.g., 6h blocks) - starting from startTime */
function computeFixedWindowSums(series, windowMinutes, startTime, endTime){
  const out = [];
  if(!startTime || !endTime) return out;
  const winMs = windowMinutes*60*1000;
  if(!series) series = [];
  series.sort((a,b)=>a.t-b.t);
  let curStart = new Date(startTime.getTime());
  while(curStart.getTime() < endTime.getTime()){
    const curEnd = new Date(Math.min(curStart.getTime() + winMs, endTime.getTime()));
    let sum = 0;
    // sum points t >= curStart && t < curEnd
    for(let i=0;i<series.length;i++){
      const tt = series[i].t.getTime();
      if(tt >= curStart.getTime() && tt < curEnd.getTime()) sum += series[i].v;
      if(tt >= curEnd.getTime()) break;
    }
    out.push({start: new Date(curStart), end: new Date(curEnd), sum: Number(sum.toFixed(1))});
    curStart = new Date(curStart.getTime() + winMs);
  }
  return out;
}

/* RENDER 6H MATRIX (table with columns per 6h block) */
function render6hMatrix(seriesMap, startTime, endTime){
  const holder = $('#matrixHolder'); holder.innerHTML = '';
  if(!seriesMap || !Object.keys(seriesMap).length){ $('#matrixArea').style.display='none'; return; }
  // build list of windows (same windows for all stations)
  const winMs = 6*60*60*1000;
  const windows = [];
  let cur = new Date(startTime.getTime());
  while(cur.getTime() < endTime.getTime()){
    const nxt = new Date(Math.min(cur.getTime()+winMs, endTime.getTime()));
    windows.push({start:new Date(cur), end:new Date(nxt)});
    cur = new Date(cur.getTime()+winMs);
  }
  // build table
  const tbl = document.createElement('table'); tbl.className='matrix-table';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.appendChild(document.createElement('th')).textContent = 'Tên trạm';
  windows.forEach(w => {
    const dt = w.start;
    const hh = pad(dt.getHours()) + 'h';
    const label = `${hh} Ngày ${pad(dt.getDate())}/${pad(dt.getMonth()+1)}`;
    const th = document.createElement('th'); th.textContent = label; headRow.appendChild(th);
  });
  thead.appendChild(headRow); tbl.appendChild(thead);

  const tbody = document.createElement('tbody');
  for(const name of Object.keys(seriesMap)){
    const row = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.className='station-col'; tdName.textContent = name; row.appendChild(tdName);
    const series = seriesMap[name] || [];
    for(const w of windows){
      // sum series points within [w.start, w.end)
      let s = 0;
      for(let i=0;i<series.length;i++){
        const tt = series[i].t.getTime();
        if(tt >= w.start.getTime() && tt < w.end.getTime()) s += series[i].v;
        if(tt >= w.end.getTime()) break;
      }
      const td = document.createElement('td'); td.textContent = s? s.toFixed(1) : '0.0'; row.appendChild(td);
    }
    tbody.appendChild(row);
  }
  tbl.appendChild(tbody);
  holder.appendChild(tbl);
  $('#matrixArea').style.display='block';
  // save last matrix as CSV rows for download
  const csvRows = [];
  for(const name of Object.keys(seriesMap)){
    const series = seriesMap[name]||[];
    const rowObj = { trạm: name };
    windows.forEach((w, i) => {
      const key = `${pad(w.start.getHours())}h ${pad(w.start.getDate())}/${pad(w.start.getMonth()+1)}`;
      // compute sum (same as above)
      let s=0;
      for(let j=0;j<series.length;j++){
        const tt=series[j].t.getTime();
        if(tt>=w.start.getTime() && tt < w.end.getTime()) s+=series[j].v;
        if(tt>=w.end.getTime()) break;
      }
      rowObj[key] = s? s.toFixed(1) : '0.0';
    });
    csvRows.push(rowObj);
  }
  window.__last6hMatrix = { windows, rows: csvRows };
  $('#btnExport6hBlocks').disabled = !(csvRows && csvRows.length);
}

/* RENDER AGGREGATES SUMMARY TABLE */
function renderAggregatesSummary(aggs){
  // re-use earlier method to render table HTML inside aggTableHolder if wanted
  // here we set window.__lastAgg for export
  const arr = Object.keys(aggs).map(name => {
    const a = aggs[name];
    return { trạm: name, 'Tổng(mm)': a.total, 'Max1h': a.max1h, 'Max3h': a.max3h, 'Max6h': a.max6h, 'Tổng3h_latest': a.latest3h, 'Tổng6h_latest': a.latest6h };
  });
  window.__lastAgg = arr;
  $('#btnExportAgg').disabled = !(arr && arr.length);
}

/* MAIN FLOW */
async function init(){
  // defaults
  const now = new Date(); const s0 = new Date(now); s0.setDate(now.getDate()-2); s0.setHours(0,0,0,0);
  $('#startDt').value = toLocalDT(s0);
  $('#endDt').value = toLocalDT(now);

  $('#btnAutoXlsx').addEventListener('click', async ()=>{ try{ await tryAutoLoadExcel(); } catch(e){ $('#xlsxStatus').textContent = e.message; }});
  $('#fileXlsx').addEventListener('change', async ev => {
    const f = ev.target.files?.[0]; if(!f) return;
    try{ const ab = await f.arrayBuffer(); const wb = XLSX.read(ab,{type:'array'}); loadFromWorkbook(wb); } catch(e){ $('#xlsxStatus').textContent = e.message; }
  });

  // bind floating export buttons
  $('#btnExportFloating').addEventListener('click', ()=> downloadCSV(window.__lastRows||[], 'rain_ketqua.csv'));
  $('#btnExportXlsxFloating').addEventListener('click', ()=> downloadXLSX(window.__lastRows||[]));

  $('#btnExport').addEventListener('click', ()=> downloadCSV(window.__lastRows||[], 'rain_ketqua.csv'));
  $('#btnExportXlsx').addEventListener('click', ()=> downloadXLSX(window.__lastRows||[]));

  $('#btnExportAgg').addEventListener('click', ()=> {
    const rows = window.__lastAgg || [];
    if(rows && rows.length) downloadCSV(rows, 'rain_tonghop.csv');
    else alert('Không có dữ liệu tổng hợp.');
  });

  $('#btnExport6hBlocks').addEventListener('click', ()=> {
    // prefer matrix CSV (wide). If not present, fallback to __last6hBlocks (flat)
    if(window.__last6hMatrix && window.__last6hMatrix.rows && window.__last6hMatrix.rows.length){
      downloadCSV(window.__last6hMatrix.rows, 'rain_6h_matrix.csv');
    } else if(window.__last6hBlocks && window.__last6hBlocks.length){
      downloadCSV(window.__last6hBlocks, 'rain_6h_blocks.csv');
    } else {
      alert('Không có dữ liệu 6h để tải.');
    }
  });

  $('#btnClear').addEventListener('click', ()=>{
    $('#thead').innerHTML=''; $('#tbody').innerHTML=''; $('#tfoot').innerHTML='';
    $('#summary').textContent='Đã xoá kết quả.'; $('#matrixArea').style.display='none';
    $('#btnExport').disabled=true; $('#btnExportXlsx').disabled=true; $('#btnExportFloating').disabled=true; $('#btnExportXlsxFloating').disabled=true;
    $('#btnExportAgg').disabled=true; $('#btnExport6hBlocks').disabled=true;
    window.__lastRows = []; window.__lastAgg=[]; window.__last6hBlocks=[]; window.__last6hMatrix=null;
  });

  $('#btnFetch').addEventListener('click', async ()=>{
    if(!stations.length){ alert('Chưa nạp danh sách trạm từ Excel.'); return; }
    const pass = $('#passcode').value.trim();
    const s = parseTimeString($('#startDt').value); const e = parseTimeString($('#endDt').value);
    if(!s || !e || !(s.getTime() < e.getTime())){ alert('Khoảng thời gian không hợp lệ.'); return; }
    const indices = Array.from($('#multiSelect').selectedOptions).map(o=>Number(o.value));
    if(!indices.length){ alert('Hãy chọn ít nhất 1 trạm.'); return; }
    const tinhtong = $('#tinhtong').checked ? 1 : 0;

    $('#summary').textContent = 'Đang lấy dữ liệu...';

    // fetch per station
    const datasets = {};
    await Promise.all(indices.map(async idx => {
      const r = stations[idx];
      const ten_table = (r.Tab || 'mucnuoc_oday');
      const sophut = Number($('#sophut').value || r.sophut || 60) || 60;
      const params = { matram: r.matram, ten_table, sophut: String(sophut), tinhtong: String(tinhtong),
                       thoigianbd: quote(`${s.getFullYear()}-${pad(s.getMonth()+1)}-${pad(s.getDate())} ${pad(s.getHours())}:${pad(s.getMinutes())}:00`),
                       thoigiankt: quote(`${e.getFullYear()}-${pad(e.getMonth()+1)}-${pad(e.getDate())} ${pad(e.getHours())}:${pad(e.getMinutes())}:00`) };
      if(pass) params.passcode = pass;
      const url = buildProxyUrl(params);
      try{
        const data = await fetchJSON(url);
        datasets[r.tentram||r.matram] = Array.isArray(data) ? data : [];
      }catch(err){
        console.warn('fetch error', err);
        datasets[r.tentram||r.matram] = [];
      }
    }));

    // pivot by time
    const timeIndex = new Map();
    const names = Object.keys(datasets);
    for(const n of names){
      for(const row of (datasets[n]||[])){
        const t = normTime(pickField(row, TIME_KEYS));
        const v = pickField(row, VALUE_KEYS);
        if(!t) continue;
        if(!timeIndex.has(t)) timeIndex.set(t, { 'thoi gian': t });
        timeIndex.get(t)[n] = v;
      }
    }
    const rows = Array.from(timeIndex.values()).sort((a,b)=> String(a['thoi gian']).localeCompare(String(b['thoi gian'])));
    renderTable(rows);

    // compute aggregates and 6h-blocks
    if($('#showAggregates').checked){
      const seriesMap = buildSeriesFromRows(rows);
      const aggs = {};
      for(const name of Object.keys(seriesMap)){
        const series = seriesMap[name];
        // total, max sliding windows, latest windows (end time = e)
        const total = series.reduce((s,x)=> s + (isFinite(x.v)?x.v:0), 0);
        const max1h = (slidingWindowSums(series,60).length ? Math.max(...slidingWindowSums(series,60)) : 0);
        const max3h = (slidingWindowSums(series,180).length ? Math.max(...slidingWindowSums(series,180)) : 0);
        const max6h = (slidingWindowSums(series,360).length ? Math.max(...slidingWindowSums(series,360)) : 0);
        const latest3h = latestWindowSum(series, e, 180);
        const latest6h = latestWindowSum(series, e, 360);
        aggs[name] = { total: Number(total.toFixed(1)), max1h: Number(max1h.toFixed(1)), max3h: Number(max3h.toFixed(1)), max6h: Number(max6h.toFixed(1)), latest3h, latest6h };
      }
      renderAggregatesSummary(aggs);

      // 6h BLOCKS: two representations:
      // 1) flat list (trạm, window_start, window_end, sum) -> __last6hBlocks
      // 2) matrix (station rows x windows cols) -> __last6hMatrix
      const flat = [];
      for(const name of Object.keys(seriesMap)){
        const blocks = computeFixedWindowSums(seriesMap[name], 360, s, e);
        for(const b of blocks){
          flat.push({ trạm: name, window_start: b.start.toISOString().replace('T',' ').slice(0,19), window_end: b.end.toISOString().replace('T',' ').slice(0,19), sum_mm: b.sum });
        }
      }
      window.__last6hBlocks = flat;
      $('#btnExport6hBlocks').disabled = !(flat && flat.length);

      // matrix view
      render6hMatrix(seriesMap, s, e);
    } else {
      $('#btnExportAgg').disabled = true; $('#btnExport6hBlocks').disabled = true;
      $('#matrixArea').style.display='none';
      window.__lastAgg = []; window.__last6hBlocks = []; window.__last6hMatrix = null;
    }
  });

  // try load xlsx automatically
  try{ await tryAutoLoadExcel(); } catch(e){ $('#xlsxStatus').textContent = 'Không tìm thấy file mặc định. Chọn thủ công.'; }
}

window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
