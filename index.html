<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LƯỢNG MƯA CÁC TRẠM TỰ ĐỘNG TRÊN ĐỊA BÀN TỈNH QUẢNG TRỊ</title>

  <style>
    body{margin:0;background:#f1f5f9;font-family:Inter,system-ui,Avenir,Helvetica,Arial,sans-serif}
    header{padding:16px;text-align:center;background:#fff;border-bottom:1px solid #e2e8f0}
    header h1{margin:0;font-size:22px;color:#1d4ed8}
    header h2{margin:4px 0 0;font-size:14px;color:#334155}

    .shell{max-width:1280px;margin:20px auto;padding:12px;display:grid;grid-template-columns:340px 1fr;gap:16px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,.05)}

    .rain-table{border-collapse:collapse;width:100%;min-width:720px}
    .rain-table th,.rain-table td{border:1px solid #e2e8f0;padding:6px 8px;text-align:center;font-size:13px}
    .rain-table th{background:#f8fafc;position:sticky;top:0;z-index:1}
    .rain-table tfoot td{font-weight:900;color:#c1121f;background:#fff5f5}

    .mm-black{color:#111827;font-weight:700}
    .mm-green{color:#16a34a;font-weight:800}
    .mm-purple{color:#7c3aed;font-weight:800}
    .mm-red{color:#dc2626;font-weight:900}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1>LƯỢNG MƯA CÁC TRẠM TỰ ĐỘNG TRÊN ĐỊA BÀN TỈNH QUẢNG TRỊ</h1>
  <h2>Phục vụ công tác phòng chống thiên tai</h2>
</header>

<div class="shell">
  <!-- Sidebar -->
  <aside class="card">
    <h3>Chọn dữ liệu</h3>
    <button id="btnAutoXlsx">Tải Excel tham số</button>
    <input type="file" id="fileXlsx" accept=".xlsx" style="margin-top:8px"/>
    <div id="xlsxStatus" style="font-size:13px;margin-top:6px;color:#64748b">Chưa tải file Excel.</div>

    <hr/>

    <label>Bắt đầu</label>
    <input type="datetime-local" id="startDt">
    <label>Kết thúc</label>
    <input type="datetime-local" id="endDt">

    <label style="margin-top:8px">Chu kỳ (phút)</label>
    <input type="number" id="sophut" value="60">

    <label style="margin-top:8px"><input type="checkbox" id="tinhtong" checked> Tính tổng theo ngày</label>

    <hr/>
    <button id="btnFetch">Lấy dữ liệu</button>
    <button id="btnClear">Xóa</button>
  </aside>

  <!-- Main -->
  <main>
    <div class="card" style="margin-bottom:16px">
      <div id="summary">Chưa có dữ liệu.</div>
    </div>

    <div class="card" style="padding:12px">
      <div class="scroll" style="overflow:auto;max-height:320px">
        <table id="dataTable" class="rain-table">
          <thead><tr id="thead"></tr></thead>
          <tbody id="tbody"></tbody>
          <tfoot><tr id="tfoot"></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="chartBox" class="card" style="margin-top:16px;min-height:360px;text-align:center;display:flex;align-items:center;justify-content:center;color:#64748b">
      Chưa có dữ liệu để vẽ đồ thị.
    </div>
  </main>
</div>

<script>
const $ = s => document.querySelector(s);
const pad = n => String(n).padStart(2,"0");
const quote = s => `'${s}'`;

function mmClass(val){
  const v = Number(val);
  if (!isFinite(v)) return "";
  if (v < 10) return "mm-black";
  if (v <= 25) return "mm-green";
  if (v <= 50) return "mm-purple";
  return "mm-red";
}

function renderTable(rows){
  const thead=$('#thead'), tbody=$('#tbody'), tfoot=$('#tfoot');
  thead.innerHTML=''; tbody.innerHTML=''; tfoot.innerHTML='';

  if(!Array.isArray(rows)||!rows.length){
    $('#summary').textContent='Không có dữ liệu.';
    return;
  }

  const cols = Object.keys(rows[0]);
  const timeCol = cols[0];
  const stationCols = cols.slice(1);

  thead.innerHTML = cols.map(c=>`<th>${c}</th>`).join('');
  const totals = Object.fromEntries(stationCols.map(c=>[c,0]));

  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r[timeCol]}</td>` +
      stationCols.map(c=>{
        const v=Number(r[c]??0); if(isFinite(v)) totals[c]+=v;
        return `<td class="${mmClass(v)}">${isFinite(v)?v.toFixed(1):''}</td>`;
      }).join('');
    tbody.appendChild(tr);
  }

  const trow=document.createElement('tr');
  trow.innerHTML=`<td><b>Tổng (mm)</b></td>`+
    stationCols.map(c=>`<td style="font-weight:900;color:#c1121f">${totals[c].toFixed(1)}</td>`).join('');
  tfoot.appendChild(trow);

  $('#summary').textContent=`Có ${rows.length} mốc thời gian — ${stationCols.length} trạm.`;
  renderChart(totals);
}

/* ==== Biểu đồ cột ==== */
function renderChart(totals){
  const host=$('#chartBox'); host.innerHTML='';
  const keys=Object.keys(totals); if(!keys.length){host.textContent="Chưa có dữ liệu.";return;}

  const W=host.clientWidth||800, H=360, m={l:50,r:20,t:20,b:50};
  const vals=Object.values(totals);
  const maxY=Math.max(...vals,10);

  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height',H);
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  host.appendChild(svg);

  const barW=(W-m.l-m.r)/keys.length*0.6;
  keys.forEach((k,i)=>{
    const v=totals[k];
    const x=m.l+i*((W-m.l-m.r)/keys.length)+((W-m.l-m.r)/keys.length-barW)/2;
    const h=(v/maxY)*(H-m.t-m.b);
    const y=H-m.b-h;

    const rect=document.createElementNS(svg.namespaceURI,'rect');
    rect.setAttribute('x',x); rect.setAttribute('y',y);
    rect.setAttribute('width',barW); rect.setAttribute('height',h);
    rect.setAttribute('fill','#3b82f6');
    svg.appendChild(rect);

    const txt=document.createElementNS(svg.namespaceURI,'text');
    txt.setAttribute('x',x+barW/2); txt.setAttribute('y',y-4);
    txt.setAttribute('text-anchor','middle');
    txt.setAttribute('font-size','11'); txt.setAttribute('fill','#111827');
    txt.textContent=v.toFixed(1);
    svg.appendChild(txt);

    const lbl=document.createElementNS(svg.namespaceURI,'text');
    lbl.setAttribute('x',x+barW/2); lbl.setAttribute('y',H-6);
    lbl.setAttribute('text-anchor','middle');
    lbl.setAttribute('font-size','11'); lbl.setAttribute('fill','#334155');
    lbl.textContent=k;
    svg.appendChild(lbl);
  });

  // Trục Y
  const yTicks=5;
  for(let i=0;i<=yTicks;i++){
    const val=i*maxY/yTicks;
    const y=H-m.b-(val/maxY)*(H-m.t-m.b);
    const line=document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1',m.l); line.setAttribute('x2',W-m.r);
    line.setAttribute('y1',y); line.setAttribute('y2',y);
    line.setAttribute('stroke','#e5e7eb');
    svg.appendChild(line);

    const t=document.createElementNS(svg.namespaceURI,'text');
    t.setAttribute('x',m.l-6); t.setAttribute('y',y+4);
    t.setAttribute('text-anchor','end'); t.setAttribute('font-size','11'); t.setAttribute('fill','#334155');
    t.textContent=val.toFixed(0);
    svg.appendChild(t);
  }
}
</script>
</body>
</html>
