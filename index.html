<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THÔNG TIN MỰC NƯỚC CÁC TRẠM THỦY VĂN — QUẢNG TRỊ</title>
  <style>
    :root{
      --bg:#f6f8ff; --card:#fff; --txt:#0f172a; --muted:#64748b; --pri:#1d4ed8;
      --ok:#16a34a; --err:#dc2626; --grid:#e2e8f0; --grid-strong:#94a3b8;
      --shadow:0 10px 30px -14px rgba(2,6,23,.25);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:grid; place-items:center; min-height:100vh;
    }

    /* ===== HEADER ===== */
    header{
      width:100%; max-width:1600px;
      position:sticky; top:0; z-index:4;
      background:linear-gradient(180deg,#fff, #fff 70%, rgba(255,255,255,.6));
      border-bottom:1px solid var(--grid); padding:18px 16px;
    }
    .title{margin:0; text-align:center; color:var(--pri); font-weight:800; letter-spacing:.4px}
    .title .l1{font-size:26px; text-transform:uppercase}
    .title .l2{font-size:13px; color:#334155; margin-top:6px; font-weight:600}

    /* ===== LAYOUT ===== */
    .shell{
      width:min(1600px, 100vw - 24px);
      margin:16px auto;
      display:grid; grid-template-columns: 420px 1fr; gap:16px;
    }
    .card{
      background:var(--card); border:1px solid var(--grid); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:14px;
    }
    .section{margin-bottom:14px}
    .section-title{
      display:flex; align-items:center; gap:8px;
      font-weight:800; color:#0b1437; margin:0 0 8px 0; font-size:14px;
    }
    .section-title .tag{font-size:11px; background:#e2e8f0; color:#334155; border-radius:999px; padding:2px 8px}

    /* ===== FORM ===== */
    label{font-size:12px; color:var(--muted); display:block; margin:4px 0}
    input,select,button,textarea{
      width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px;
      font-size:14px; background:#fff;
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .full{grid-column:1/-1}
    .btn{background:var(--pri); color:#fff; border:none; cursor:pointer; font-weight:700}
    .btn.secondary{background:#64748b}
    .btn.ghost{background:#eef2ff; color:#1e40af}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .status{font-size:12px; margin-top:6px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}

    /* ===== TOOLBAR ===== */
    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position:sticky; top:calc(64px + 16px); z-index:3;
    }
    .summary{font-size:13px; color:#1f2937}
    .toolbar-actions{display:flex; gap:8px}

    /* ===== RESULTS GRID (table left + chart right) ===== */
    .results-grid{
      display:grid;
      grid-template-columns:minmax(440px,48%) 1fr;
      gap:12px;
      align-items:start;
    }

    /* ===== TABLE (LOG) ===== */
    .scroll{overflow:auto; border:1px solid var(--grid); border-radius:12px; background:#fff}
    table{width:max-content; border-collapse:separate; border-spacing:0; font-size:12px; white-space:nowrap}
    thead th, tbody td{
      padding:8px 12px; text-align:center; vertical-align:middle;
      border-right:1.5px solid var(--grid-strong); border-bottom:1.5px solid var(--grid-strong);
    }
    thead th:first-child, tbody td:first-child{border-left:1.5px solid var(--grid-strong)}
    thead th{
      position:sticky; top:0; z-index:2; background:#f1f5f9; border-bottom-color:#64748b;
      font-weight:800;
    }
    thead th:first-child{left:0; z-index:4}
    tbody td:first-child{position:sticky; left:0; background:#fff; z-index:3; text-align:left}

    /* ===== DATETIME ===== */
    .dt{display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end; position:relative; z-index:30;}
    .dt input[type="datetime-local"]{
      height:44px; background:#f8fafc; border:1.5px solid var(--grid-strong); font-weight:600; letter-spacing:.2px;
      padding-right:36px; position:relative; z-index:31;
    }

    /* ===== ALERT TABLE (STATIC) ===== */
    .alert-box{border:2px solid #ef4444; border-radius:12px; padding:10px}
    .alert-scroll{max-height:270px; overflow:auto; border:1px solid #fecaca; border-radius:10px; background:#fff}
    .alert-table{width:100%; border-collapse:separate; border-spacing:0; font-size:12px}
    .alert-table th,.alert-table td{
      padding:6px 8px; text-align:center; vertical-align:middle;
      border-right:1px solid #fecaca; border-bottom:1px solid #fecaca
    }
    .alert-table th:first-child,.alert-table td:first-child{border-left:1px solid #fecaca}
    .alert-table thead th{position:sticky; top:0; background:#fff5f5; z-index:1}
    .alert-table tbody td{color:#dc2626; font-weight:700}
    .name-left{text-align:left}

    /* ===== DETAIL SUMMARY (ADDED) ===== */
    .detail-table{border-collapse:separate; border-spacing:0; font-size:12px; min-width:900px}
    .detail-table thead th, .detail-table tbody td{padding:6px 10px; border-right:1px solid var(--grid-strong); border-bottom:1px solid var(--grid-strong); text-align:center}
    .detail-table tbody td.station{position:sticky; left:0; background:#fff; text-align:left; font-weight:700; z-index:3; min-width:180px}
    .badge{display:inline-block;padding:4px 8px;border-radius:8px;font-weight:700}
    .ok{background:#d1fae5;color:#065f46}
    .warn{background:#fef3c7;color:#92400e}
    .danger{background:#fee2e2;color:#7f1d1d}
    .muted{color:var(--muted);font-size:12px}

    @media (max-width:1100px){
      .shell{grid-template-columns:1fr}
      .toolbar{top:calc(64px + 8px)}
      .results-grid{grid-template-columns:1fr}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1 class="title">
    <div class="l1">THÔNG TIN MỰC NƯỚC CÁC TRẠM THỦY VĂN TRÊN ĐỊA BÀN TỈNH QUẢNG TRỊ</div>
    <div class="l2">Phục vụ công tác phòng chống thiên tai</div>
  </h1>
</header>

<div class="shell">
  <!-- ===== SIDEBAR ===== -->
  <aside class="card">
    <!-- Nguồn dữ liệu -->
    <div class="section">
      <h3 class="section-title">Nguồn dữ liệu <span class="tag">Excel + API</span></h3>
      <div class="row">
        <button id="btnAutoXlsx" class="btn">Tải tự động</button>
        <input type="file" id="fileXlsx" accept=".xlsx" />
      </div>
      <div id="xlsxStatus" class="status">Chưa tải file Excel.</div>
      <div class="status" style="color:var(--muted)">
        Đặt <b>thamso_khaithac.xlsx</b> vào thư mục <b>public/</b> của dự án; giữ nguyên các cột:
        <code>matram, tentram, matinh, Tab, sophut, tinhtong</code>.
      </div>
      <label class="full" style="margin-top:8px">Passcode (nếu API yêu cầu)</label>
      <input id="passcode" type="text" placeholder="để trống nếu không cần">
    </div>

    <hr style="border:none;border-top:1px solid var(--grid); margin:10px 0">

    <!-- Chọn trạm & thời gian -->
    <div class="section">
      <h3 class="section-title">Chọn trạm & thời gian</h3>
      <label>Chọn các trạm (Giữ Ctrl/Shift để chọn nhiều)</label>
      <select id="multiSelect" multiple size="10" style="height:240px"></select>
      <div class="status" style="color:var(--muted)">Mặc định chọn 4 trạm đầu tiên. Chọn nhiều trạm: bảng sẽ có thanh kéo ngang.</div>

      <div class="dt" style="margin-top:10px">
        <div>
          <label>Bắt đầu</label>
          <input type="datetime-local" id="startDt">
        </div>
        <div>
          <label>Kết thúc</label>
          <input type="datetime-local" id="endDt">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Chu kỳ (sophut)</label>
          <input type="number" id="sophut" min="1" step="1" value="60">
        </div>
        <div>
          <label>ten_table (mặc định lấy theo Excel)</label>
          <input id="tenTable" placeholder="để trống để lấy theo Excel">
        </div>
      </div>

      <label style="margin-top:8px"><input type="checkbox" id="tinhtong"> Tính tổng theo ngày (tinhtong=1)</label>
    </div>

    <!-- Thao tác -->
    <div class="section">
      <h3 class="section-title">Thao tác</h3>
      <div class="row">
        <button id="btnFetch" class="btn">Lấy dữ liệu</button>
        <button id="btnClear" class="btn secondary">Xoá kết quả</button>
      </div>
    </div>

    <!-- Bảng báo động (cố định) -->
    <div class="section alert-box">
      <h3 class="section-title" style="margin-bottom:6px">Mực nước ứng với cấp báo động (m)</h3>
      <div class="alert-scroll">
        <table class="alert-table">
          <thead>
            <tr><th style="width:42px">TT</th><th>Tên sông</th><th>Tên trạm</th><th>I</th><th>II</th><th>III</th></tr>
          </thead>
          <tbody>
            <tr><td>1</td><td class="name-left">Gianh</td><td class="name-left">Mai Hóa</td><td>3.0</td><td>5.0</td><td>6.5</td></tr>
            <tr><td>2</td><td class="name-left">Gianh</td><td class="name-left">Đồng Tâm</td><td>7.0</td><td>13.0</td><td>16.0</td></tr>
            <tr><td>3</td><td class="name-left">Gianh</td><td class="name-left">Tân Mỹ</td><td>1.1</td><td>1.3</td><td>1.5</td></tr>
            <tr><td>4</td><td class="name-left">Kiến Giang</td><td class="name-left">Lệ Thủy</td><td>1.2</td><td>2.2</td><td>2.7</td></tr>
            <tr><td>5</td><td class="name-left">Kiến Giang</td><td class="name-left">Kiến Giang</td><td>8.0</td><td>11.0</td><td>13.0</td></tr>
            <tr><td>6</td><td class="name-left">Nhật Lệ</td><td class="name-left">Đồng Hới</td><td>1.0</td><td>1.5</td><td>2.0</td></tr>
            <tr><td>7</td><td class="name-left">Hiếu</td><td class="name-left">Đông Hà</td><td>2.0</td><td>3.0</td><td>4.0</td></tr>
            <tr><td>8</td><td class="name-left">Thạch Hãn</td><td class="name-left">Thạch Hãn</td><td>3.0</td><td>4.5</td><td>6.0</td></tr>
            <tr><td>9</td><td class="name-left">Cửa Việt</td><td class="name-left">Cửa Việt</td><td>1.0</td><td>1.5</td><td>2.0</td></tr>
            <tr><td>10</td><td class="name-left">Bến Hải</td><td class="name-left">Gia Vòng</td><td>5.0</td><td>8.0</td><td>11.0</td></tr>
            <tr><td>11</td><td class="name-left">Bến Hải</td><td class="name-left">Hiền Lương</td><td>1.0</td><td>2.0</td><td>2.5</td></tr>
            <tr><td>12</td><td class="name-left">Roon</td><td class="name-left">Quảng Phú</td><td>1.3</td><td>2.1</td><td>2.7</td></tr>
            <tr><td>13</td><td class="name-left">Gianh</td><td class="name-left">Quảng Thanh</td><td>1.2</td><td>2.1</td><td>2.7</td></tr>
            <tr><td>14</td><td class="name-left">Rào Nan</td><td class="name-left">Cao Quảng</td><td>28.5</td><td>31.0</td><td>33.0</td></tr>
            <tr><td>15</td><td class="name-left">Son</td><td class="name-left">Phong Nha</td><td>3.5</td><td>5.0</td><td>6.5</td></tr>
            <tr><td>16</td><td class="name-left">Lý Hòa</td><td class="name-left">Lý Hòa</td><td>1.1</td><td>2.0</td><td>2.5</td></tr>
            <tr><td>17</td><td class="name-left">Nhật Lệ</td><td class="name-left">Hàm Ninh</td><td>1.2</td><td>2.0</td><td>3.0</td></tr>
            <tr><td>18</td><td class="name-left">Đakrông</td><td class="name-left">Đakrông</td><td>29.5</td><td>31.5</td><td>33.5</td></tr>
            <tr><td>19</td><td class="name-left">Hiếu</td><td class="name-left">Đầu Mầu</td><td>21.0</td><td>22.5</td><td>23.5</td></tr>
            <tr><td>20</td><td class="name-left">SaLung</td><td class="name-left">Bến Quan</td><td>4.0</td><td>5.5</td><td>6.5</td></tr>
            <tr><td>21</td><td class="name-left">Ô Lâu</td><td class="name-left">Mỹ Chánh</td><td>2.5</td><td>4.0</td><td>5.3</td></tr>
            <tr><td>22</td><td class="name-left">Ô Lâu</td><td class="name-left">Hải Tân</td><td>1.8</td><td>2.8</td><td>3.4</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <main style="display:grid; gap:16px;">
    <div class="card toolbar">
      <div class="summary" id="summary">Chưa có dữ liệu. Hãy chọn trạm & thời gian rồi bấm “Lấy dữ liệu”.</div>
      <div class="toolbar-actions">
        <button id="btnExport" class="btn ghost" disabled>Tải CSV</button>
        <button id="btnExportXlsx" class="btn ghost" disabled>Tải Excel (.xlsx)</button>
      </div>
    </div>

    <!-- KẾT QUẢ: bảng trái + đồ thị phải -->
    <div class="card" style="padding:12px">
      <div class="results-grid">
        <div class="scroll" id="tableBox" style="padding:0">
          <table>
            <thead><tr id="thead"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <!-- Chart box -->
        <div id="chartBox" class="card" style="min-height:360px">
          <div style="font-size:12px;color:#64748b">
            Chưa có dữ liệu để vẽ đồ thị.
          </div>
        </div>
      </div>

      <!-- ===== ADDED: BẢNG TỔNG HỢP (GIỐNG ẢNH) =====
           - Giữ nguyên giao diện cũ, chèn bảng ngay dưới vùng results-grid
           - Bảng được sinh từ window.__LAST_DATASETS (được tạo khi bấm Lấy dữ liệu)
      -->
      <div style="margin-top:12px">
        <div style="font-weight:800; margin-bottom:6px">BẢNG TỔNG HỢP CHI TIẾT (như mẫu)</div>
        <div class="scroll" style="border-radius:10px; padding:8px; background:#fff">
          <table class="detail-table" id="detailTable">
            <thead id="detailHead">
              <tr>
                <th>Trạm thủy văn</th>
                <th>I</th>
                <th>II</th>
                <th>III</th>
                <!-- dynamic recent time columns will be injected here by JS -->
                <th>SSB1</th>
                <th>SSB2</th>
                <th>SSB3</th>
                <th>Hiện trạng</th>
              </tr>
            </thead>
            <tbody id="detailBody"></tbody>
          </table>
        </div>
      </div>
      <!-- ===== END ADDED ===== -->
    </div>
  </main>
</div>

<script>
/* ===== CONFIG (Netlify Proxy) ===== */
const API_PROXY = "/.netlify/functions/proxy";
const DEFAULT_XLSX_PATH = "/thamso_khaithac.xlsx";
const EXCEL_SHEET = "KhaibaoQuangtri";

/* ===== UTIL ===== */
const $ = s => document.querySelector(s);
const pad = n => String(n).padStart(2,"0");
const toLocalDatetimeValue = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
const quote = s => `'${s}'`;
function buildProxyUrl(p){ return `${API_PROXY}?` + new URLSearchParams(p).toString(); }

/* CSV/XLSX Export */
function toCSV(rows){
  if(!rows?.length) return "";
  const cols = Object.keys(rows[0]);
  const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
  const head = cols.map(esc).join(",");
  const body = rows.map(r => cols.map(c => esc(r[c])).join(",")).join("\n");
  return head+"\n"+body;
}
function downloadCSV(rows){
  const csv = toCSV(rows);
  const bom = '\uFEFF';
  const blob = new Blob([bom, csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'mucnuoc_ketqua.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function downloadXLSX(rows){
  if (!rows?.length) return;
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'DuLieu');
  XLSX.writeFile(wb, 'mucnuoc_ketqua.xlsx');
}

/* Fetch JSON (fallback AllOrigins nếu CORS lỗi) */
async function fetchJSON(url){
  async function doFetch(u){
    const res = await fetch(u, { credentials:'include' });
    const text = await res.text();
    if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
    try { return JSON.parse(text); }
    catch(e){ throw new Error(text.slice(0,180)); }
  }
  try { return await doFetch(url); }
  catch(e){
    const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
    return await doFetch(proxy);
  }
}

/* ===== READ EXCEL (STATIONS) ===== */
let stations=[];
function normalizeRow(r){
  const pick=(a,b)=> (a!==undefined && a!=='')?a:b;
  return {
    matram:String(pick(r.matram,r.MATRAM)||'').trim(),
    tentram:String(pick(r.tentram,r.TENTRAM)||'').trim(),
    matinh:pick(r.matinh,r.MATINH)||'',
    Tab:String(pick(r.Tab,r.tab)||'').trim(),
    sophut:Number(pick(r.sophut,r.SOPHUT)||60)||60,
    tinhtong:Number(pick(r.tinhtong,r.TINHTONG)||0)||0
  };
}
function loadFromWorkbook(wb){
  const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(ws,{defval:''});
  stations = arr.map(normalizeRow).filter(r=>r.matram);
  if (!stations.length) throw new Error('Không đọc được danh sách trạm từ Excel.');
  $('#xlsxStatus').className='status ok';
  $('#xlsxStatus').textContent=`Đã nạp ${stations.length} trạm.`;
  fillStationSelects();
}
async function tryAutoLoadExcel(){
  $('#xlsxStatus').textContent='Đang tải thamso_khaithac.xlsx…';
  const res = await fetch(DEFAULT_XLSX_PATH);
  if (!res.ok) throw new Error('Không thấy /thamso_khaithac.xlsx (đặt file vào thư mục public/)');
  const ab = await res.arrayBuffer();
  const wb = XLSX.read(ab,{type:'array'});
  loadFromWorkbook(wb);
}

/* ===== UI ===== */
function fillStationSelects(){
  const box=$('#multiSelect'); box.innerHTML='';
  stations.forEach((r,i)=>{
    const o=document.createElement('option');
    o.value=i; o.textContent=(r.tentram||'(không tên)').trim();
    box.appendChild(o);
  });
  // default: select first 4 originally, but user asked to keep original default.
  // Keep original behavior: select 4 first by default (as original code said).
for(let i=0;i<box.options.length;i++){ box.options[i].selected = true; }
}
function renderTable(rows){
  const thead=$('#thead'), tbody=$('#tbody'); thead.innerHTML=''; tbody.innerHTML='';
  if(!Array.isArray(rows)||!rows.length){
    thead.innerHTML='<th>(trống)</th>';
    $('#summary').textContent='Không có dữ liệu để hiển thị.';
    $('#btnExport').disabled=true; $('#btnExportXlsx').disabled=true;
    renderChart([]);  // dọn chart
    return;
  }
  const cols=Object.keys(rows[0]);
  thead.innerHTML=cols.map(c=>`<th>${c}</th>`).join('');
  const frag=document.createDocumentFragment();
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=cols.map(c=>`<td>${r[c]??''}</td>`).join('');
    frag.appendChild(tr);
  }
  tbody.appendChild(frag);
  $('#summary').textContent = `Hiển thị ${rows.length} mốc thời gian — ${cols.length-1} trạm.`;
  $('#btnExport').disabled=false; $('#btnExportXlsx').disabled=false;
  window.__lastRows = rows;

  // VẼ ĐỒ THỊ từ chính rows đang hiển thị
  renderChart(rows);
}

/* ===== PIVOT BY TIME ===== */
function pickField(row, keys){ for(const k of keys){ if(row[k]!==undefined && row[k]!==null && row[k]!=='' ) return row[k]; } }
const TIME_KEYS=['thoigian','Thoigian','thoigian_SL','Thoigian_SL','ThoiGian','ThoiGian_SL','time','datetime','date','Ngay','NgayGio','ngaygio'];
const VALUE_KEYS=['solieu','SoLieu','Solieu','GiaTri','giatri','mucnuoc','MucNuoc','value','LuongMua','luongmua','Mua'];
const normTime=t=> (t==null?'':String(t).trim().replace('T',' '));

/* ===== DATE LIMITS ===== */
function pad2(n){return String(n).padStart(2,'0')}
function toLocalDT(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`}
function fiveDaysAgoMidnight(){ const n=new Date(); n.setDate(n.getDate()-5); n.setHours(0,0,0,0); return n; }
function setDateLimits(){
  const now=new Date();
  const startEl = $('#startDt');
  const endEl   = $('#endDt');

  const minStart = fiveDaysAgoMidnight();
  startEl.min = toLocalDT(minStart);
  startEl.max = toLocalDT(now);

  if (!startEl.value || new Date(startEl.value) < minStart) startEl.value = toLocalDT(minStart);
  if (new Date(startEl.value) > now) startEl.value = toLocalDT(now);

  endEl.min = startEl.value;
  endEl.max = toLocalDT(now);

  if (!endEl.value || new Date(endEl.value) < new Date(startEl.value)) endEl.value = toLocalDT(now);
  if (new Date(endEl.value) > now) endEl.value = toLocalDT(now);
}

/* ===== CHART HELPERS: BD1/BD2/BD3 từ bảng cảnh báo ===== */
function normName(s){
  return (s??"").toString()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .replace(/\s+/g," ").trim().toLowerCase();
}
function initBDLevels(){
  const map = new Map();
  const rows = document.querySelectorAll(".alert-table tbody tr");
  rows.forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    const tenTram = tds[2]?.textContent?.trim() ?? ""; // cột tên trạm
    const bd1 = Number((tds[3]?.textContent ?? "").replace(",", "."));
    const bd2 = Number((tds[4]?.textContent ?? "").replace(",", "."));
    const bd3 = Number((tds[5]?.textContent ?? "").replace(",", "."));
    if(tenTram){
      map.set(normName(tenTram), {
        name: tenTram,
        bd1: Number.isFinite(bd1) ? bd1 : null,
        bd2: Number.isFinite(bd2) ? bd2 : null,
        bd3: Number.isFinite(bd3) ? bd3 : null
      });
    }
  });
  window.__BD_MAP = map;
}
function findBDFor(stationName){
  const key = normName(stationName);
  const map = window.__BD_MAP || new Map();
  if(map.has(key)) return map.get(key);
  for(const [k,v] of map.entries()){
    if(k.includes(key) || key.includes(k)) return v; // khớp gần đúng
  }
  return null;
}

/* ===== CHART (SVG thuần, robust) ===== */
function parseTimeMaybe(s){
  if(s==null) return NaN;
  const t=String(s).trim(); if(!t) return NaN;
  if(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(:\d{2})?$/.test(t)) return new Date(t.replace(" ","T")).getTime();
  let m=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if(m){ const[,dd,mm,yy,HH,MM,SS="00"]=m; return new Date(`${yy}-${pad(dd)}-${pad(mm)}T${HH}:${MM}:${SS}`).getTime(); }
  m=t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if(m){ const[,dd,mm,yy,HH,MM,SS="00"]=m; return new Date(`${yy}-${pad(mm)}-${pad(dd)}T${HH}:${MM}:${SS}`).getTime(); }
  const p=Date.parse(t); return Number.isNaN(p)?NaN:p;
}
function toNum(v){ const n=parseFloat(String(v??"").trim().replace(",", ".")); return Number.isFinite(n)?n:NaN; }

function buildSeriesFromRows(rows){
  if(!Array.isArray(rows)||!rows.length) return {series:[], xType:"empty", xValues:[], xLabels:[]};
  const keys=Object.keys(rows[0]);
  const timeKey = keys.find(k => k.toLowerCase().includes('thoi') && k.toLowerCase().includes('gian'))
                 || keys.find(k => /time|ngay|date/i.test(k))
                 || null;

  let xType="time", xValues=[], xLabels=[];
  if(timeKey){
    const parsed = rows.map(r=>parseTimeMaybe(r[timeKey]));
    const ok = parsed.filter(v=>!Number.isNaN(v)).length;
    if(ok>=2){ xType="time"; xValues=parsed; xLabels=rows.map(r=>String(r[timeKey]??"")); }
    else { xType="index"; xValues=rows.map((_,i)=>i); xLabels=rows.map((r,i)=>String(r[timeKey]??`#${i+1}`)); }
  }else{
    xType="index"; xValues=rows.map((_,i)=>i); xLabels=rows.map((_,i)=>`#${i+1}`);
  }

  const series=[];
  for(const k of keys){
    if(k===timeKey) continue;
    const pts=[];
    for(let i=0;i<rows.length;i++){
      const y=toNum(rows[i][k]); const x=xValues[i];
      if(!Number.isNaN(x)&&Number.isFinite(y)) pts.push({x,y});
    }
    if(pts.length>=2){ pts.sort((a,b)=>a.x-b.x); series.push({name:k, data:pts}); }
  }
  return {series, xType, xValues, xLabels};
}

function renderChart(rows){
  const host = $('#chartBox');
  host.innerHTML = '';
  const title = document.createElement('div');
  title.style.cssText='font-size:12px;color:#64748b;margin-bottom:8px';
  title.textContent='Đồ thị quá trình mực nước — dữ liệu từ bảng đang hiển thị.';
  host.appendChild(title);

  const {series, xType, xValues, xLabels} = buildSeriesFromRows(rows);
  if(!series.length){
    const div=document.createElement('div'); div.style.cssText='font-size:12px;color:#64748b';
    div.textContent='Không đủ dữ liệu số để vẽ đồ thị.';
    host.appendChild(div); return;
  }

  const bar=document.createElement('div');
  bar.style.cssText='display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px';
  host.appendChild(bar);

  let selected=series[0].name;

  function draw(){
    const old=host.querySelector('svg'); if(old) old.remove();
    const sel=series.find(s=>s.name===selected) || series[0];
    const data=sel.data;

    const W=host.clientWidth||800, H=330, m={l:48,r:16,t:12,b:28};
    const minX=Math.min(...data.map(d=>d.x)), maxX=Math.max(...data.map(d=>d.x));
    let minY=Math.min(...data.map(d=>d.y)), maxY=Math.max(...data.map(d=>d.y));
    if(minY===maxY) maxY=minY+1e-6;

    const sx=x=> m.l + ((x-minX)/(maxX-minX||1))*(W-m.l-m.r);
    const sy=y=> H-m.b - ((y-minY)/(maxY-minY||1))*(H-m.t-m.b);

    const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('width','100%'); svg.setAttribute('height',H);
    svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
    host.appendChild(svg);

    const yTicks=5, xTicks=Math.min(6, Math.max(1, data.length-1));
    const yStep=(maxY-minY)/yTicks, xStep=(maxX-minX)/xTicks;

    // grid
    for(let i=0;i<=yTicks;i++){
      const y=sy(minY+i*yStep);
      const line=document.createElementNS(svg.namespaceURI,'line');
      line.setAttribute('x1',m.l); line.setAttribute('y1',y);
      line.setAttribute('x2',W-m.r); line.setAttribute('y2',y);
      line.setAttribute('stroke','#e2e8f0'); line.setAttribute('stroke-dasharray','3 3');
      svg.appendChild(line);
    }
    for(let i=0;i<=xTicks;i++){
      const x=sx(minX+i*xStep);
      const line=document.createElementNS(svg.namespaceURI,'line');
      line.setAttribute('x1',x); line.setAttribute('y1',m.t);
      line.setAttribute('x2',x); line.setAttribute('y2',H-m.b);
      line.setAttribute('stroke','#e2e8f0'); line.setAttribute('stroke-dasharray','3 3');
      svg.appendChild(line);
    }

    // Đường quá trình (màu xanh)
    let d=`M ${sx(data[0].x)} ${sy(data[0].y)}`;
    for(let i=1;i<data.length;i++) d += ` L ${sx(data[i].x)} ${sy(data[i].y)}`;
    const path=document.createElementNS(svg.namespaceURI,'path');
    path.setAttribute('d', d); path.setAttribute('fill','none');
    path.setAttribute('stroke','#0ea5e9'); path.setAttribute('stroke-width','2');
    svg.appendChild(path);

    // ===== VẼ BĐ1/BĐ2/BĐ3 (vàng/da cam/đỏ) nếu có =====
    const lv = findBDFor(sel.name);
    const COLORS = { bd1:'#eab308', bd2:'#f97316', bd3:'#ef4444' };
    function drawHLine(val, color, label){
      if(val==null || !Number.isFinite(val)) return;
      const y = sy(val);
      if (y < m.t-4 || y > H-m.b+4) return; // ngoài khung thì bỏ
      const line=document.createElementNS(svg.namespaceURI,'line');
      line.setAttribute('x1',m.l); line.setAttribute('y1',y);
      line.setAttribute('x2',W-m.r); line.setAttribute('y2',y);
      line.setAttribute('stroke',color); line.setAttribute('stroke-width','1.8');
      line.setAttribute('stroke-dasharray','6 4');
      svg.appendChild(line);

      const tag=document.createElementNS(svg.namespaceURI,'text');
      tag.setAttribute('x', W - m.r - 4);
      tag.setAttribute('y', y - 4);
      tag.setAttribute('text-anchor','end');
      tag.setAttribute('font-size','11');
      tag.setAttribute('font-weight','700');
      tag.setAttribute('fill', color);
      tag.textContent = `${label} (${val})`;
      svg.appendChild(tag);
    }
    if(lv){
      drawHLine(lv.bd1, COLORS.bd1, 'BĐ1');
      drawHLine(lv.bd2, COLORS.bd2, 'BĐ2');
      drawHLine(lv.bd3, COLORS.bd3, 'BĐ3');
    }

    // Nhãn trục X
    function labelAt(xv){
      if(xType==='time'){
        let lo=0, hi=xValues.length-1;
        while(hi-lo>1){ const mid=(lo+hi)>>1; (xValues[mid]<xv) ? (lo=mid):(hi=mid); }
        const idx=(Math.abs(xValues[lo]-xv)<=Math.abs(xValues[hi]-xv))?lo:hi;
        const raw=xLabels[idx]||'';
        const m=/\b(\d{2}):(\d{2})/.exec(String(raw));
        return m?`${m[1]}:${m[2]}`:String(raw);
      } else {
        const i=Math.round(xv);
        return xLabels[i] || `#${i+1}`;
      }
    }
    for(let i=0;i<=xTicks;i++){
      const xv=minX+i*xStep, x=sx(xv);
      const t=document.createElementNS(svg.namespaceURI,'text');
      t.setAttribute('x',x); t.setAttribute('y',H-6);
      t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','11'); t.setAttribute('fill','#334155');
      t.textContent=labelAt(xv);
      svg.appendChild(t);
    }
    for(let i=0;i<=yTicks;i++){
      const yv=minY+i*yStep, y=sy(yv);
      const t=document.createElementNS(svg.namespaceURI,'text');
      t.setAttribute('x',m.l-6); t.setAttribute('y',y+4);
      t.setAttribute('text-anchor','end'); t.setAttribute('font-size','11'); t.setAttribute('fill','#334155');
      t.textContent=yv.toFixed(2);
      svg.appendChild(t);
    }
  }

  // Nút chọn series
  series.forEach(s=>{
    const b=document.createElement('button');
    b.textContent=s.name;
    b.style.cssText='padding:6px 10px;border:1px solid #cbd5e1;border-radius:8px;background:#f8fafc;font-size:13px;cursor:pointer';
    b.addEventListener('click',()=>{
      selected=s.name;
      [...bar.children].forEach(x=>{ x.style.background='#f8fafc'; x.style.color='initial'; });
      b.style.background='#2563eb'; b.style.color='#fff';
      draw();
    });
    bar.appendChild(b);
  });
  if(bar.firstChild){ bar.firstChild.click(); } else { draw(); }

  const ro = new ResizeObserver(()=>draw());
  ro.observe($('#chartBox'));
}

/* ===== DETAIL SUMMARY BUILD + RENDER (ADDED) ===== */
function fmt(v, d=2){ if(v==null || Number.isNaN(v)) return ''; return Number(v).toFixed(d); }

function buildDetailSummaryRows(stationsList, datasets){
  const bdmap = window.__BD_MAP || new Map();
  const rows = [];
  for(const s of stationsList){
    const name = s.tentram || s.matram;
    const data = datasets[name] || datasets[s.matram] || [];
    const pts = data.map(r=>{
      const t = TIME_KEYS.map(k=>r[k]).find(x=>x!==undefined);
      const v = VALUE_KEYS.map(k=>r[k]).find(x=>x!==undefined);
      return {t: normTime(t), v: toNum(v)};
    }).filter(p=>p.t && !Number.isNaN(p.v)).sort((a,b)=>parseTimeMaybe(a.t)-parseTimeMaybe(b.t));
    const lastN = 7;
    const lastSlice = pts.slice(Math.max(0, pts.length-lastN));
    const lastVals = lastSlice.map(x=>x.v);
    const lastTimes = lastSlice.map(x=>x.t);
    const lastVal = lastVals.length? lastVals[lastVals.length-1] : null;
    const bd = (function(){
      const found = findBDFor(name);
      return found || {bd1:null,bd2:null,bd3:null};
    })();
    const ssb1 = (lastVal!=null && bd.bd1!=null)? (lastVal - bd.bd1) : null;
    const ssb2 = (lastVal!=null && bd.bd2!=null)? (lastVal - bd.bd2) : null;
    const ssb3 = (lastVal!=null && bd.bd3!=null)? (lastVal - bd.bd3) : null;
    let state = '';
    let cls = '';
    if(lastVal==null){ state='No data'; cls=''; }
    else if(bd.bd3!=null && lastVal >= bd.bd3){ state='Vượt BĐ3'; cls='danger'; }
    else if(bd.bd2!=null && lastVal >= bd.bd2){ state='Vượt BĐ2'; cls='warn'; }
    else if(bd.bd1!=null && lastVal >= bd.bd1){ state='Vượt BĐ1'; cls='warn'; }
    else { state='Bình thường'; cls='ok'; }
    rows.push({
      tentram: name,
      bd1: bd.bd1, bd2: bd.bd2, bd3: bd.bd3,
      lastVals, lastTimes, lastVal, ssb1, ssb2, ssb3, state, cls
    });
  }
  return rows;
}

function renderDetailTable(){
  const stationsList = window.__STATIONS_LIST || stations;
  const datasets = window.__LAST_DATASETS || {};
  const rows = buildDetailSummaryRows(stationsList, datasets);

  // compute global recent timestamps across datasets (up to 7)
  const allTimes = [];
  Object.values(datasets).forEach(arr=>{
    arr.forEach(r=>{
      const t = pickField(r, TIME_KEYS);
      if(t) allTimes.push(normTime(t));
    });
  });
  const uniqTimes = Array.from(new Set(allTimes)).sort((a,b)=>parseTimeMaybe(a)-parseTimeMaybe(b));
  const lastTimesGlobal = uniqTimes.slice(Math.max(0, uniqTimes.length-7));

  // header
  let hdr = '<tr><th>Trạm thủy văn</th><th>I</th><th>II</th><th>III</th>';
  for(const t of lastTimesGlobal) hdr += `<th style="min-width:64px">${t}</th>`;
  hdr += '<th>SSB1</th><th>SSB2</th><th>SSB3</th><th>Hiện trạng</th></tr>';
  document.getElementById('detailHead').innerHTML = hdr;

  // body
  const tbody = document.getElementById('detailBody'); tbody.innerHTML = '';
  for(const r of rows){
    const tr = document.createElement('tr');
    let html = `<td class="station">${r.tentram}</td>`;
    html += `<td>${fmt(r.bd1)}</td><td>${fmt(r.bd2)}</td><td>${fmt(r.bd3)}</td>`;
    for(const t of lastTimesGlobal){
      const idx = r.lastTimes.indexOf(t);
      const v = idx>=0 ? r.lastVals[idx] : '';
      html += `<td>${v!==''?fmt(v):''}</td>`;
    }
    html += `<td>${r.ssb1!=null?fmt(r.ssb1):''}</td>`;
    html += `<td>${r.ssb2!=null?fmt(r.ssb2):''}</td>`;
    html += `<td>${r.ssb3!=null?fmt(r.ssb3):''}</td>`;
    const badge = r.cls ? `<span class="badge ${r.cls}">${r.state}</span>` : r.state;
    html += `<td>${badge}</td>`;
    tr.innerHTML = html;
    tbody.appendChild(tr);
  }
  window.__DETAIL_ROWS = rows;
}

/* ===== MAIN FLOW ===== */
async function init(){
  // mặc định: start = 00:00 của 2 ngày trước; end = now
  const now=new Date(), s0=new Date(now); s0.setDate(now.getDate()-2); s0.setHours(0,0,0,0);
  $('#startDt').value=toLocalDT(s0);
  $('#endDt').value=toLocalDT(now);
  setDateLimits();
  $('#startDt').addEventListener('change', setDateLimits);
  $('#endDt').addEventListener('change', setDateLimits);

  $('#btnAutoXlsx').addEventListener('click', async ()=>{
    try{ await tryAutoLoadExcel(); }catch(e){ $('#xlsxStatus').className='status err'; $('#xlsxStatus').textContent=e.message; }
  });
  $('#fileXlsx').addEventListener('change', async ev=>{
    const f=ev.target.files?.[0]; if(!f) return;
    try{ const ab=await f.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); loadFromWorkbook(wb); }
    catch(e){ $('#xlsxStatus').className='status err'; $('#xlsxStatus').textContent=e.message; }
  });

  $('#btnFetch').addEventListener('click', async ()=>{
    if(!stations.length){ alert('Chưa nạp danh sách trạm từ Excel.'); return; }
    const pass=$('#passcode').value.trim();
    let s=new Date($('#startDt').value), e=new Date($('#endDt').value);
    if(!(s.getTime()<e.getTime())){ alert('Khoảng thời gian không hợp lệ.'); return; }

    const indices=Array.from($('#multiSelect').selectedOptions).map(o=>Number(o.value));
    if(!indices.length){ alert('Hãy chọn ít nhất 1 trạm.'); return; }

    const tinhtong=$('#tinhtong').checked?1:0;
    if(tinhtong===1){ s.setHours(0,0,0,0); e.setHours(23,59,0,0);
      $('#startDt').value=toLocalDT(s); $('#endDt').value=toLocalDT(e);
    }
    const fmt=(dt)=>`${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:00`;
    const sStr=fmt(s), eStr=fmt(e);

    const datasets={};
    $('#summary').textContent='Đang lấy dữ liệu…';
    await Promise.all(indices.map(async idx=>{
      const r=stations[idx];
      const ten_table=($('#tenTable').value.trim()||r.Tab||'mucnuoc_oday');
      const sophut=Number($('#sophut').value||r.sophut||60)||60;
      const params={ matram:r.matram, ten_table, sophut:String(sophut), tinhtong:String(tinhtong),
                     thoigianbd:quote(sStr), thoigiankt:quote(eStr) };
      if(pass) params.passcode=pass;
      const url=buildProxyUrl(params);
      try{
        const data=await fetchJSON(url);
        datasets[r.tentram||r.matram]=Array.isArray(data)?data:[];
      }catch(e){
        console.warn('Fetch lỗi', r.matram, e);
        datasets[r.tentram||r.matram]=[];
      }
    }));

    // lưu datasets & stations global để phần tổng hợp dùng
    window.__LAST_DATASETS = datasets;
    window.__STATIONS_LIST = stations;
    try{ localStorage.setItem('__LAST_DATASETS_JSON', JSON.stringify(datasets)); }catch(e){/* ignore storage errors */ }

    // pivot theo thời gian (giữ nguyên)
    const timeIndex=new Map();
    const names=Object.keys(datasets);
    for(const n of names){
      for(const row of (datasets[n]||[])){
        const t=normTime(pickField(row, TIME_KEYS));
        const v=pickField(row, VALUE_KEYS);
        if(!t) continue;
        if(!timeIndex.has(t)) timeIndex.set(t, {"thoi gian": t});
        timeIndex.get(t)[n]=v;
      }
    }
    const rows=Array.from(timeIndex.values())
      .sort((a,b)=>String(a['thoi gian']).localeCompare(String(b['thoi gian'])));
    renderTable(rows);

    // cập nhật bảng tổng hợp chi tiết (mới thêm) — không làm thay đổi giao diện gốc
    initBDLevels();
    renderDetailTable();
    $('#summary').textContent='Hoàn tất lấy dữ liệu.';
  });

  $('#btnClear').addEventListener('click', ()=>{
    $('#thead').innerHTML=''; $('#tbody').innerHTML='';
    $('#detailHead').innerHTML = '<tr><th>Trạm thủy văn</th><th>I</th><th>II</th><th>III</th><th>SSB1</th><th>SSB2</th><th>SSB3</th><th>Hiện trạng</th></tr>';
    $('#detailBody').innerHTML='';
    $('#summary').textContent='Đã xoá kết quả.';
    $('#btnExport').disabled=true; $('#btnExportXlsx').disabled=true;
    renderChart([]);
  });

  // Export
  $('#btnExport').addEventListener('click', ()=> downloadCSV(window.__lastRows||[]));
  $('#btnExportXlsx').addEventListener('click', ()=> downloadXLSX(window.__lastRows||[]));

  // Khởi tạo map ngưỡng BĐ từ bảng cảnh báo
  initBDLevels();

  try{ await tryAutoLoadExcel(); }
  catch(e){ $('#xlsxStatus').className='status'; $('#xlsxStatus').textContent='Không tìm thấy file mặc định. Hãy chọn file .xlsx thủ công.'; }

  // nếu có cached datasets, nạp vào detail table
  try{
    const ds = localStorage.getItem('__LAST_DATASETS_JSON');
    if(ds){
      window.__LAST_DATASETS = JSON.parse(ds);
      window.__STATIONS_LIST = stations;
      renderDetailTable();
    }
  }catch(e){}
}
window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
